apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: forgejo
  namespace: {{ .Values.config.metadata.namespace | quote }}
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  project: ops
  destination:
    namespace: ops
    server: {{ .Values.config.spec.destination.server | quote }}
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
  source:
    chart: forgejo
    repoURL: code.forgejo.org/forgejo-helm
    targetRevision: 16.0.1
    helm:
      valuesObject:
        ingress:
          enabled: true
          hosts:
          - host: forge.stargrid.systems
        persistence:
          size: 10Gi
        signing: {} # TODO: enable!
        # TODO: set up oauth with nextcloud
        # TODO: database
        gitea:
          config:
            APP_NAME: "STARGRID Forgejo"
            repository:
              DEFAULT_PRIVATE: private
              PREFERRED_LICENSES: AGPL-3.0-or-later
            repository.pull-request:
              DEFAULT_MERGE_STYLE: squash
              DEFAULT_UPDATE_STYLE: rebase
            cors:
              ENABLED: true
              ALLOW_DOMAIN: https://forge.stargrid.systems
            server:
              DOMAIN: forge.stargrid.systems
              ROOT_URL: https://forge.stargrid.systems/
              # TODO: ssh using hostPort?
              DISABLE_SSH: true
            service:
              DISABLE_REGISTRATION: true
            quota:
              ENABLED: true
            quota.default:
              TOTAL: 5G
